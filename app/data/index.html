<!DOCTYPE html>
<html charset="UTF-8">
  <head>
    <meta name="viewport">
    <!-- <script src='https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js'></script> -->
    <script src="js/jquery.min.js"></script>
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.1/umd/popper.min.js"></script> -->
    <script src="js/popper.min.js"></script>
    <!-- <script src='https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js'></script> -->
    <script src="js/bootstrap.min.js"></script>
    <!-- <script src="https://unpkg.com/bootstrap-table@1.18.0/dist/bootstrap-table.min.js"></script> -->
    <script src="js/bootstrap-table.min.js"></script>
    <!-- <link rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.18.0/dist/bootstrap-table.min.css"> -->
    <link rel="stylesheet" href="css/bootstrap-table.min.css">
    <link href="https://maxcdn.bootstrapcdn.com/bootswatch/4.5.2/cyborg/bootstrap.min.css" rel="stylesheet" title="main">
    <!-- <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"> -->
    <!-- <link rel="stylesheet" href="css/bootstrap.min.css">  NOT USED-READ FROM CDN!-->
    <link href="/img/baca_favicon.ico" rel="icon" type="image/x-icon"/>
    <title>USBMUX</title>
  </head>
  <body>
    <div class="container-fluid">
      
        <a class="navbar-brand">
          <div class="row">
            <div class="col-xs-2 col-md-2">
                <img src="img/baca_logo.jpg" width="60" height="60">
            </div>
            <div class="col-xs-6 col-md-6">
                <h1>USBMUX by luk6xff</h1>
            </div>
          </div>
        </a>
      <ul class="nav nav-tabs nav-justified" id="tab">
        <li><a class="nav-link active" href="#tab_usbmux" data-toggle="tab">USB Multiplexer</a></li>
        <li><a class="nav-link" href="#tab_devinfo" data-toggle="tab">Device Info</a></li>
        <li><a class="nav-link" href="#tab_configuration" data-toggle="tab">Configuration</a></li>
      </ul>
      <div class="tab-content">
        <div class="tab-pane fade show active" id="tab_usbmux">
          <h2>USB Multiplexer</h2>
          <div class="m-4"></div>
          <div class="row m-4">
            <div class="col-xs-3 col-md-3" style="margin-top: 0">
              <h4 class="text-left">CH_0
                <div class="span badge" id="ch_0_state">OFF</div>
              </h4>
              <div class="form-group form-check">
                <label class="form-check-label" for="ch_0_usbid">
                    <input class="form-check-input" type="checkbox" id="ch_0_usbid" data-toggle="toggle"> USB_ID
                </label>
              </div>
            </div>
            <div class="col-xs-5 col-md-5">
              <div class="button btn btn-success btn-md btn-block" id="ch_0_on" type="button">ON</div>
              <div class="button btn btn-danger btn-md btn-block" id="ch_0_off" type="button">OFF</div>
            </div>
          </div>
          <div class="m-4"></div>
          <div class="row m-4">
            <div class="col-xs-3 col-md-3" style="margin-top: 0">
              <h4 class="text-left">CH_1
                <div class="span badge" id="ch_1_state">OFF</div>
              </h4>
              <div class="form-group form-check">
                <label class="form-check-label" for="ch_1_usbid">
                    <input class="form-check-input" type="checkbox" id="ch_1_usbid" data-toggle="toggle"> USB_ID
                </label>
              </div>
            </div>
            <div class="col-xs-5 col-md-5">
              <div class="button btn btn-success btn-md btn-block" id="ch_1_on" type="button">ON</div>
              <div class="button btn btn-danger btn-md btn-block" id="ch_1_off" type="button">OFF</div>
            </div>
          </div>
          <div class="m-4"></div>
          <div class="row m-4">
            <div class="col-xs-3 col-md-3">
              <h4 class="text-left" style="margin-center: 0">POWER
                <div class="span badge" id="power_state">OFF</div>
              </h4>
            </div>
            <div class="col-xs-5 col-md-5">
              <div class="button btn btn-success btn-md btn-block" id="power_on" type="button">ON</div>
              <div class="button btn btn-danger btn-md btn-block" id="power_off" type="button">OFF</div>
            </div>
          </div>
        </div>
        <div class="tab-pane fade" id="tab_devinfo">
          <h2>Device Info</h2>
          <ul class="nav nav-pills">
            <li class="active"><a href="#">
                <div class="span badge pull-right" id="free_heap">-</div> Free Heap</a></li>
            <li><a href="#">
                <div class="span badge pull-right" id="free_stack">-</div> Free Stack</a></li>
          </ul><br>
          <table id="table_devinfo" data-toggle="table" data-show-colunns="true">
            <thead>
              <tr>
                <th data-field="name" data-align="left" data-sortable="true" data-formatter="nameFormatter">Name</th>
                <th data-field="value" data-align="left" data-sortable="true" data-formatter="valueFormatter">Value</th>
              </tr>
            </thead>
          </table>
        </div>
        <div class="tab-pane fade" id="tab_configuration">
          <h2>Configuration        </h2>
          <div class="btn-group">
            <button class="btn btn-default" id="labelTheme">Theme</button>
            <button class="btn btn-default dropdown-toggle" data-toggle="dropdown"><span class="caret"></span></button>
            <ul class="dropdown-menu">
              <li><a class="change-style-menu-item" href="#" rel="bootstrap">Boostrap</a></li>
              <li><a class="change-style-menu-item" href="#" rel="cerulean">Cerulean</a></li>
              <li><a class="change-style-menu-item" href="#" rel="cosmo">Cosmo</a></li>
              <li><a class="change-style-menu-item" href="#" rel="cyborg">Cyborg</a></li>
              <li><a class="change-style-menu-item" href="#" rel="darkly">Darkly</a></li>
              <li><a class="change-style-menu-item" href="#" rel="flatly">Flatly</a></li>
              <li><a class="change-style-menu-item" href="#" rel="journal">Journal</a></li>
              <li><a class="change-style-menu-item" href="#" rel="lumen">Lumen</a></li>
              <li><a class="change-style-menu-item" href="#" rel="paper">Paper</a></li>
              <li><a class="change-style-menu-item" href="#" rel="readable">Readable</a></li>
              <li><a class="change-style-menu-item" href="#" rel="sandstone">Sandstone</a></li>
              <li><a class="change-style-menu-item" href="#" rel="simplex">Simplex</a></li>
              <li><a class="change-style-menu-item" href="#" rel="slate">Slate</a></li>
              <li><a class="change-style-menu-item" href="#" rel="spacelab">Spacelab</a></li>
              <li><a class="change-style-menu-item" href="#" rel="superhero">Superhero</a></li>
              <li><a class="change-style-menu-item" href="#" rel="united">United</a></li>
              <li><a class="change-style-menu-item" href="#" rel="yeti">Yeti  </a></li>
            </ul>
          </div>
        </div>
      </div>
    </div>
    <!-- Footer -->
    <footer class="page-footer font-small blue pt-4">
      <!-- Copyright -->
      <div class="footer-copyright text-center">(C) 2020 luk6xff Copyright:
        <a href="https://www.github.com/luk6xff/usbmux">Project details on my github!</a>
      </div>
      <!-- Copyright -->
    </footer>
    <!-- Footer -->

    <!--script(src='js/script.js')-->
    <script>
      var timer_updateDevInfo;

      $('a[data-toggle=\"tab\"]').on('shown.bs.tab', function (e) {
        clearTimeout(timer_updateDevInfo);
        var target = $(e.target).attr("href")
        console.log('activated ' + target );

        // IE10, Firefox, Chrome, etc.
        if (history.pushState)
          window.history.pushState(null, null, target);
        else
          window.location.hash = target;

        if (target=='#tab_devinfo')  {
          $('#table_devinfo').bootstrapTable('refresh',{silent:true, url:'/devinfotable.json'});
        }
      });

      // Create a timer to update device info data every n secondes
      $('#tab_devinfo').on('load-success.bs.table',function (e,data) {
        console.log("tab_devinfo loaded");
        if ($('.nav-tabs .active > a').attr('href')=='#tab_devinfo') {
          timer_updateDevInfo=setTimeout(function() {
            $('#table_devinfo').bootstrapTable('refresh',{silent: true, showLoading: false, url: '/devinfotable.json'});
            updateDeviceInfo();
          },5000);
        }
      });

      function updateDeviceInfo() {
        $.getJSON('/devinfo.json', function(data) {
          console.log("Device Info : " + JSON.stringify(data) + "|" + data.free_heap + "|" + data.free_stack) ;
          $('#free_heap').html(data.free_heap);
          $('#free_stack').html(data.free_stack);
        }).fail(function(err) {
          console.log("err getJSON devinfo.json "+JSON.stringify(err));
        });
      };

      function nameFormatter(value, row) {
        //console.log("nameFormatter");
        //console.log(value);
        //console.log(row);
        var label = value + " " + "<span class='glyphicon " + row.glyph + " pull-left'></span>";
        return label;
      }

      function valueFormatter(value, row) {
        //console.log("valueFormatter");
        var label = "";
        if (row.unit != "") {
          row.unit = "[" + row.unit + "]"
        }
        label = value + " " + row.unit;
        return label;
      }

      // USB Multiplexer commands change
      $('#ch_0_on').click(function()  { setButton('ch_0','on'); });
      $('#ch_0_off').click(function() { setButton('ch_0','off'); });

      $('#ch_1_on').click(function()  { setButton('ch_1','on'); });
      $('#ch_1_off').click(function() { setButton('ch_1','off'); });

      $('#power_on').click(function()  { setButton('power','on'); });
      $('#power_off').click(function() { setButton('power','off'); });


      function setButton(pin, pinState) {
        // Check is usbIdStae Exists for this pin
        var usbIdPinState = false;
        if (document.getElementById(pin + "_usbid") != null) {
            usbIdPinState = document.getElementById(pin + "_usbid").checked;    
        }
        //console.log("usbIdPinState: " + usbIdPinState);
        $.post("usbmux?pin="+pin + "&pinstate="+pinState + "&usbidstate="+usbIdPinState).done(function(data) {
          //console.log("setButton " + JSON.stringify(data));
          var pin_id_usbmux = "#" + pin + "_state";
          //console.log(pin_id_usbmux);
          if (data.success === "true") {
            if (data.pinstate === "on") {
              $(pin_id_usbmux).html("ON");
            } else {
              $(pin_id_usbmux).html("OFF");
            }
          } else {
            $(pin_id_usbmux).html('!');
          }
        }).fail(function(err) {
          console.log("err setButton " + JSON.stringify(err));
        });
      }

      // Change current theme
      // Adapted from : https://wdtz.org/bootswatch-theme-selector.html
      var supports_storage = supports_html5_storage();
      if (supports_storage) {
        var theme = localStorage.theme;
        console.log("Theme was loaded: " + theme);
        if (theme) {
          set_theme(get_themeUrl(theme));
        }
      }

      // New theme selected
      jQuery(function($) {
        $('body').on('click', '.change-style-menu-item', function() {
          var theme_name = $(this).attr('rel');
          console.log("New theme selected: " + theme_name);
          var theme_url = get_themeUrl(theme_name);
          console.log("URL theme : " + theme_url);
          set_theme(theme_url);
        });
      });

      // Get theme URL
      function get_themeUrl(theme_name) {
        $('#labelTheme').html("Theme: " + theme_name);
        var url_theme = "";
        if ( theme_name === "bootstrap" ) {
          url_theme = "https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css";
        } else {
          url_theme = "https://maxcdn.bootstrapcdn.com/bootswatch/4.5.2/" + theme_name + "/bootstrap.min.css";
        }
        if (supports_storage) {
          // Save the selected theme into the local database
          localStorage.theme = theme_name;
        }
        return url_theme;
      }

      // Apply a new theme
      function set_theme(theme_url) {
        $('link[title="main"]').attr('href', theme_url);
      }

      // Is a local storage available ?
      function supports_html5_storage() {
        try {
          return 'localStorage' in window && window['localStorage'] !== null;
        } catch (e) {
          return false;
        }
      }
    </script>
  </body>
</html>